<Project Sdk="Microsoft.NET.Sdk">
	
	<PropertyGroup>
		<TargetFramework>netstandard2.0</TargetFramework>
		<IsTool>true</IsTool>
		<IncludeBuildOutput>false</IncludeBuildOutput>
	</PropertyGroup>
	
	<ItemGroup>
		<PackageReference Include="MSBuildTasks" Version="1.5.0.235" />
	</ItemGroup>

	<Target Name="RunBuild" AfterTargets="Build">

		<CallTarget Targets="BuildVersion">
			<Output TaskParameter="TargetOutputs" PropertyName="_VersionOutput"/>
		</CallTarget>

		<ItemGroup>
			<PackageVersion Include="$(_VersionOutput.Split(';')[0])" />
			<PackageBuildNumber Include="$(_VersionOutput.Split(';')[1])" />
		</ItemGroup>

		<PropertyGroup>
			<BuildOptions>$(BuildOptions);Configuration=Release;PackageVersion=@(PackageVersion);PackageBuildNumber=@(PackageBuildNumber)</BuildOptions>

			<SolutionPath>../Calculator.sln</SolutionPath>
			
			<BuildOptions Condition="'$(BuildPlatformTarget)'=='iOS'">$(BuildOptions);Platform=iPhone</BuildOptions>
			<SolutionPath Condition="'$(BuildPlatformTarget)'=='iOS'">../Calculator.iOS/Calculator.iOS.csproj</SolutionPath>
			
			<SolutionPath Condition="'$(BuildPlatformTarget)'=='Wasm'">../Calculator.Wasm/Calculator.Wasm.csproj</SolutionPath>
		</PropertyGroup>

		<Message Text="Building $(SolutionPath) with $(BuildOptions)" Importance="high" />

		<MSBuild Properties="$(BuildOptions)"
						 Targets="Restore;Build"
						 Projects="$(SolutionPath)" />
	</Target>

	<Target Name="BuildVersion"
                  Outputs="$(_AppVersion);$(_BuildNumber)"
                  Condition="'$(GITVERSION_InformationalVersion)'!=''">
    <!-- Build Number -->
    <PropertyGroup>
      <_BuildNumber>$(PackageBuildNumber)</_BuildNumber>
      <_BuildNumber Condition="'$(BUILD_REPOSITORY_PROVIDER)' == 'TfsVersionControl'">$(BUILD_SOURCEVERSION.Substring(1))</_BuildNumber>
    </PropertyGroup>

    <Message Text="%0A#### Running BuildVersion"
                     Importance="$(_MessageImportance)" />

    <Exec Command="git rev-list --count HEAD"
                Condition="'$(_BuildNumber)' == ''"
                ConsoleToMSBuild="true">
      <Output TaskParameter="ConsoleOutput"
                      PropertyName="_BuildNumber" />
    </Exec>

    <PropertyGroup>
      <_BuildNumber Condition="$(BuildNumberOffset) != ''">$([MSBuild]::Add($(_BuildNumber), $(BuildNumberOffset)))</_BuildNumber>
      <_InformationalVersion>$(PackageInformationalVersion)</_InformationalVersion>
      <_InformationalVersion Condition="'$(_InformationalVersion)' == ''">$(GITVERSION_InformationalVersion)</_InformationalVersion>
      <_AppVersion>$(PackageVersion)</_AppVersion>
      <_AppVersion Condition="'$(_AppVersion)'==''">$(GitVersion_MajorMinorPatch)</_AppVersion>
    </PropertyGroup>

    <Error Condition="'$(_InformationalVersion)'=='' Or '$(_AppVersion)'==''"
                 Text="Failed to calculate version. You must either run GitVersion before building the application or set both AppVersion and InformationalVersion variables."/>

    <!-- App version without revision -->
    <PropertyGroup Condition="'$(IncludeBuildInVersion)' == 'True'">
      <_AppVersion>$(GitVersion_Major).$(GitVersion_Minor).$(_BuildNumber)</_AppVersion>
    </PropertyGroup>

    <!-- Pad the version in case it's too short -->
    <PropertyGroup Condition="'$(IncludeBuildInVersion)' != 'True'">
      <_AppVersion Condition="$(_AppVersion.Split('.').length) == 1">$(_AppVersion).0.0</_AppVersion>
      <_AppVersion Condition="$(_AppVersion.Split('.').length) == 2">$(_AppVersion).0</_AppVersion>
    </PropertyGroup>

    <!-- App revision -->
    <PropertyGroup>
      <AppRevision Condition="'$(AppRevision)'==''">0</AppRevision>
      <_AppVersion>$(_AppVersion).$(AppRevision)</_AppVersion>
    </PropertyGroup>

    <Message Text="App version : $(_AppVersion)"
                     Importance="$(_MessageImportance)" />
    <Message Text="Build number : $(_BuildNumber)"
                     Importance="$(_MessageImportance)" />
    <Message Text="Informational version : $(_InformationalVersion)"
                     Importance="$(_MessageImportance)" />

    <!-- Create official assembly version files with right version number -->
    <AssemblyInfo
        CodeLanguage="CS"
        OutputFile="..\AssemblyVersion.Uwp.cs"
        AssemblyVersion="$(_AppVersion)"
        AssemblyFileVersion="$(_BuildNumber)"
        AssemblyProduct="$(ProjectName) for Windows"
        AssemblyCompany="$(CompanyName)"
        AssemblyInformationalVersion="$(_InformationalVersion)"
        AssemblyCopyright="Copyright (C) $(CompanyName) $([System.DateTime]::Now.Year)" />

    <AssemblyInfo
        CodeLanguage="CS"
        OutputFile="..\AssemblyVersion.Wasm.cs"
        AssemblyVersion="$(_AppVersion)"
        AssemblyFileVersion="$(_BuildNumber)"
        AssemblyProduct="$(ProjectName) for WebAssembly"
        AssemblyCompany="$(CompanyName)"
        AssemblyInformationalVersion="$(_InformationalVersion)"
        AssemblyCopyright="Copyright (C) $(CompanyName) $([System.DateTime]::Now.Year)" />

    <AssemblyInfo
        CodeLanguage="CS"
        OutputFile="..\AssemblyVersion.iOS.cs"
        AssemblyVersion="$(_AppVersion)"
        AssemblyFileVersion="$(_BuildNumber)"
        AssemblyProduct="$(ProjectName) for iOS"
        AssemblyCompany="$(CompanyName)"
        AssemblyInformationalVersion="$(_InformationalVersion)"
        AssemblyCopyright="Copyright (C) $(CompanyName) $([System.DateTime]::Now.Year)" />

    <AssemblyInfo
        CodeLanguage="CS"
        OutputFile="..\AssemblyVersion.Android.cs"
        AssemblyVersion="$(_AppVersion)"
        AssemblyFileVersion="$(_BuildNumber)"
        AssemblyProduct="$(ProjectName) for Android"
        AssemblyCompany="$(CompanyName)"
        AssemblyInformationalVersion="$(_InformationalVersion)"
        AssemblyCopyright="Copyright (C) $(CompanyName) $([System.DateTime]::Now.Year)" />

    <Message Text="#### Done running BuildVersion"
                     Importance="$(_MessageImportance)" />
    <Message Text="%0A"
                     Importance="$(_MessageImportance)" />
  </Target>
	
</Project>
